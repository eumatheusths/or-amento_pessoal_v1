---
export const prerender = false;
import Layout from '../layouts/Layout.astro';
import { getUserTransactions } from '../lib/db';

// --- SEGURAN√áA E DADOS ---
if (!Astro.cookies.has('user_session')) return Astro.redirect('/login');
const userId = Astro.cookies.get('user_session')?.value;

const urlParams = Astro.url.searchParams;
const hoje = new Date();
const mesAtual = parseInt(urlParams.get('mes')) || (hoje.getMonth() + 1);
const anoAtual = parseInt(urlParams.get('ano')) || hoje.getFullYear();
const paramsUrl = `?mes=${mesAtual}&ano=${anoAtual}`;

const transactions = await getUserTransactions(userId, mesAtual, anoAtual);
const todasTransacoes = transactions; 

// --- C√ÅLCULOS ---
const totalEntradas = transactions.filter(t => t.type === 'entrada').reduce((acc, t) => acc + t.amount, 0);
const totalSaidas = transactions.filter(t => t.type === 'saida').reduce((acc, t) => acc + t.amount, 0);
const saldoPrevisto = totalEntradas - totalSaidas;
const porcentagemGasta = totalEntradas > 0 ? Math.min((totalSaidas / totalEntradas) * 100, 100) : (totalSaidas > 0 ? 100 : 0);
const estourouOrcamento = totalSaidas > totalEntradas && totalEntradas > 0;

const money = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);

// --- DADOS DO GR√ÅFICO ---
const gastosPorCat = {};
transactions.filter(t => t.type === 'saida').forEach(t => {
    const cat = t.category && t.category.trim() !== '' ? t.category : 'Geral';
    gastosPorCat[cat] = (gastosPorCat[cat] || 0) + t.amount;
});
const chartLabels = Object.keys(gastosPorCat);
const chartData = Object.values(gastosPorCat);

// --- DATAS E LINKS ---
const dataDisplay = new Date(anoAtual, mesAtual - 1, 1).toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
const prevDate = new Date(anoAtual, mesAtual - 2, 1);
const nextDate = new Date(anoAtual, mesAtual, 1);
const linkPrev = `/dashboard?mes=${prevDate.getMonth() + 1}&ano=${prevDate.getFullYear()}`;
const linkNext = `/dashboard?mes=${nextDate.getMonth() + 1}&ano=${nextDate.getFullYear()}`;
---

<Layout>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <div class="flex min-h-screen bg-gray-50 dark:bg-slate-950">
        
        <aside class="hidden md:flex flex-col w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 fixed h-full z-20">
            <div class="p-6 flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">$</div>
                <h1 class="font-bold text-xl text-slate-800 dark:text-white tracking-tight">Storm<span class="text-blue-500">Fin</span></h1>
            </div>

            <nav class="flex-1 px-4 space-y-2 mt-4">
                <p class="px-4 text-xs font-semibold text-slate-400 uppercase mb-2">Menu</p>
                <a href="/dashboard" class="flex items-center gap-3 px-4 py-3 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-xl font-medium transition-colors">
                    üìä Dashboard
                </a>
                <a href="/adicionar" class="flex items-center gap-3 px-4 py-3 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl transition-colors">
                    ‚ûï Novo Lan√ßamento
                </a>
                <a href="/metas" class="flex items-center gap-3 px-4 py-3 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl transition-colors">
                    üéØ Metas
                </a>
                <a href="/relatorio" class="flex items-center gap-3 px-4 py-3 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl transition-colors">
                    üìë Relat√≥rios
                </a>
                <a href="/investimentos" class="flex items-center gap-3 px-4 py-3 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl transition-colors">
                    üìà Investimentos
                </a>
            </nav>

            <div class="p-4 border-t border-slate-200 dark:border-slate-800">
                <a href="/logout" class="flex items-center gap-2 text-red-500 hover:text-red-600 px-4 py-2 text-sm font-medium transition-colors">
                    üö™ Sair do Sistema
                </a>
            </div>
        </aside>

        <main class="flex-1 md:ml-64 p-4 md:p-8 max-w-7xl mx-auto w-full">

            <nav class="md:hidden flex justify-between items-center mb-6">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold">$</div>
                    <div>
                        <h1 class="font-bold text-slate-800 dark:text-white">Finance Storm</h1>
                        <p class="text-xs text-slate-500 dark:text-slate-400 capitalize">{dataDisplay}</p>
                    </div>
                </div>
                <div class="flex items-center gap-1 bg-white dark:bg-slate-800 rounded-full p-1 shadow-sm border border-slate-200 dark:border-slate-700">
                    <a href={linkPrev} class="w-7 h-7 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500">‚ùÆ</a>
                    <a href={linkNext} class="w-7 h-7 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500">‚ùØ</a>
                </div>
            </nav>

            <header class="hidden md:flex justify-between items-end mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-slate-800 dark:text-white">Vis√£o Geral</h2>
                    <p class="text-slate-500 dark:text-slate-400">Acompanhe suas finan√ßas de <span class="capitalize font-semibold text-blue-600 dark:text-blue-400">{dataDisplay}</span></p>
                </div>
                <div class="flex items-center gap-4 bg-white dark:bg-slate-800 p-2 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                    <a href={linkPrev} class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg text-slate-600 dark:text-slate-300 transition">
                        ‚ùÆ M√™s Anterior
                    </a>
                    <span class="font-bold text-slate-800 dark:text-white px-2 capitalize">{new Date(anoAtual, mesAtual - 1).toLocaleString('pt-BR', { month: 'long' })}</span>
                    <a href={linkNext} class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg text-slate-600 dark:text-slate-300 transition">
                        Pr√≥ximo M√™s ‚ùØ
                    </a>
                </div>
            </header>

            {estourouOrcamento && (
                <div class="mb-6 bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 p-4 rounded-r-xl shadow-sm flex items-start gap-4 animate-pulse">
                    <div class="text-3xl">üö®</div>
                    <div>
                        <p class="font-bold text-red-800 dark:text-red-200">Cuidado!</p>
                        <p class="text-sm text-red-700 dark:text-red-300 mt-1">Oiee! Suas contas est√£o maiores que seu sal√°rio, saca?</p>
                        <p class="text-xs text-red-600/70 dark:text-red-400 mt-2 font-mono">D√©ficit previsto: {money(Math.abs(saldoPrevisto))}</p>
                    </div>
                </div>
            )}

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                
                <div class="lg:col-span-2 space-y-6">
                    
                    {totalEntradas === 0 && (
                        <div class="bg-orange-100 dark:bg-orange-900/30 border border-orange-200 dark:border-orange-700 p-4 rounded-2xl flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">üí∏</span>
                                <div>
                                    <p class="font-bold text-orange-800 dark:text-orange-100 text-sm">Sem renda lan√ßada</p>
                                    <p class="text-xs text-orange-600 dark:text-orange-300">Cadastre seu sal√°rio para ver o saldo real.</p>
                                </div>
                            </div>
                            <a href="/adicionar?tipo=entrada" class="bg-orange-500 text-white text-xs font-bold px-3 py-2 rounded-lg hover:bg-orange-600 transition">Lan√ßar</a>
                        </div>
                    )}

                    <div class="bg-gradient-to-br from-blue-600 to-blue-800 dark:from-blue-700 dark:to-blue-900 p-8 rounded-3xl shadow-xl text-white relative overflow-hidden h-64 flex flex-col justify-between">
                        <div class="absolute top-0 right-0 w-40 h-40 bg-white/10 rounded-full -mr-10 -mt-10 blur-3xl"></div>
                        
                        <div>
                            <p class="text-blue-100 font-medium mb-1 opacity-90">Saldo Previsto Final</p>
                            <h2 class={`text-5xl font-bold tracking-tight ${saldoPrevisto < 0 ? 'text-red-200' : 'text-white'}`}>
                                {money(saldoPrevisto)}
                            </h2>
                        </div>

                        <div class="relative w-full">
                            <div class="flex justify-between text-xs text-blue-100 mb-1">
                                <span>Comprometido: {Math.round(porcentagemGasta)}%</span>
                                <span>Dispon√≠vel</span>
                            </div>
                            <div class="overflow-hidden h-3 text-xs flex rounded-full bg-black/20">
                                <div style={`width:${porcentagemGasta}%`} class={`shadow-none flex flex-col text-center whitespace-nowrap justify-center transition-all duration-700 ${porcentagemGasta > 90 ? 'bg-red-400' : 'bg-emerald-400'}`}></div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mt-2 pt-4 border-t border-white/10">
                            <div>
                                <span class="text-xs text-blue-200 block uppercase tracking-wider">Entradas</span>
                                <span class="font-bold text-xl text-emerald-300">{money(totalEntradas)}</span>
                            </div>
                            <div>
                                <span class="text-xs text-blue-200 block uppercase tracking-wider">Sa√≠das</span>
                                <span class="font-bold text-xl text-red-300">{money(totalSaidas)}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 p-6 rounded-3xl shadow-sm flex flex-col">
                    <h3 class="font-bold text-slate-700 dark:text-white mb-4">Gastos por Categoria</h3>
                    {chartData.length > 0 ? (
                        <div class="flex-1 min-h-[200px] relative">
                            <canvas id="myChart"></canvas>
                        </div>
                    ) : (
                        <div class="flex-1 flex items-center justify-center text-slate-400 text-sm">
                            Sem gastos para exibir
                        </div>
                    )}
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <div class="relative flex-1">
                    <input type="text" id="search-input" placeholder="Buscar lan√ßamentos..." 
                        class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-white rounded-xl pl-10 pr-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none transition shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-slate-400 absolute left-3 top-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </div>
                <div class="flex gap-2 overflow-x-auto pb-1 md:pb-0 scrollbar-hide">
                    <button onclick="window.filterType('all')" id="btn-all" class="filter-btn active whitespace-nowrap px-4 py-2 rounded-lg font-bold bg-blue-600 text-white shadow-md transition-all text-sm">Todos</button>
                    <button onclick="window.filterType('entrada')" id="btn-entrada" class="filter-btn whitespace-nowrap px-4 py-2 rounded-lg font-bold bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 transition-all text-sm">Entradas</button>
                    <button onclick="window.filterType('saida')" id="btn-saida" class="filter-btn whitespace-nowrap px-4 py-2 rounded-lg font-bold bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 transition-all text-sm">Sa√≠das</button>
                    <button onclick="window.filterType('pendente')" id="btn-pendente" class="filter-btn whitespace-nowrap px-4 py-2 rounded-lg font-bold bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 transition-all text-sm">A Pagar ‚è≥</button>
                </div>
            </div>

            <div id="lista-transacoes" class="space-y-3 pb-10">
                {todasTransacoes.map(t => (
                    <div class="transacao-item group bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800 p-4 rounded-2xl flex justify-between items-center hover:shadow-md hover:border-blue-200 dark:hover:border-blue-900 transition-all" 
                         data-type={t.type} 
                         data-status={t.status} 
                         data-desc={t.description.toLowerCase()} 
                         data-cat={t.category ? t.category.toLowerCase() : 'geral'}>
                        
                        <div class="flex items-center gap-4">
                            <div class={`w-12 h-12 rounded-2xl flex items-center justify-center text-xl shrink-0 ${t.type === 'entrada' ? 'bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400' : 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400'}`}>
                                {t.type === 'entrada' ? '‚Üë' : '‚Üì'}
                            </div>
                            <div>
                                <div class="flex items-center gap-2">
                                    <p class="font-bold text-slate-800 dark:text-white text-base">{t.description}</p>
                                    {t.status === 'pendente' && <span class="text-[10px] uppercase font-bold tracking-wide bg-yellow-100 text-yellow-700 dark:bg-yellow-900/50 dark:text-yellow-400 px-2 py-0.5 rounded-md">Pendente</span>}
                                </div>
                                <div class="flex items-center gap-3 text-xs text-slate-500 dark:text-slate-400 mt-0.5">
                                    <span class="flex items-center gap-1">üìÖ {t.date}</span>
                                    <span class="flex items-center gap-1 bg-slate-100 dark:bg-slate-800 px-2 rounded-full capitalize">üè∑Ô∏è {t.category || 'Geral'}</span>
                                    {t.method && <span class="capitalize hidden sm:inline">üí≥ {t.method}</span>}
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex flex-col items-end gap-2">
                            <p class={`font-bold text-base md:text-lg ${t.type === 'entrada' ? 'text-green-600 dark:text-green-400' : 'text-slate-800 dark:text-white'}`}>
                                {t.type === 'saida' && '- '}{money(t.amount)}
                            </p>

                            <div class="flex items-center gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                                {t.status === 'pendente' && (
                                    <form action={"/pagar" + paramsUrl} method="POST">
                                        <input type="hidden" name="id" value={t.id} />
                                        <button title="Marcar como Pago" class="bg-green-100 hover:bg-green-200 text-green-700 p-1.5 rounded-lg transition"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></button>
                                    </form>
                                )}
                                <a href={`/editar?id=${t.id}`} class="bg-blue-100 hover:bg-blue-200 text-blue-700 p-1.5 rounded-lg transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                                </a>
                                <form action={"/deletar" + paramsUrl} method="POST" onsubmit="return confirm('Excluir?')">
                                    <input type="hidden" name="id" value={t.id} />
                                    <button title="Excluir" class="bg-red-100 hover:bg-red-200 text-red-600 p-1.5 rounded-lg transition"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                                </form>
                            </div>
                        </div>
                    </div>
                ))}
                
                {todasTransacoes.length === 0 && (
                    <div class="text-center py-16 text-slate-400 border-2 border-dashed border-slate-200 dark:border-slate-800 rounded-3xl">
                        <p class="text-lg mb-2">Nada lan√ßado neste m√™s.</p>
                        <a href="/adicionar" class="text-blue-500 font-bold hover:underline">Adicionar primeira conta</a>
                    </div>
                )}
                
                <div id="no-results" class="hidden text-center py-10 text-slate-400">
                    <p>Nenhum lan√ßamento encontrado com esse filtro.</p>
                </div>
            </div>
        </main>
    </div>

    <script is:inline define:vars={{ chartLabels, chartData }}>
        document.addEventListener('DOMContentLoaded', () => {
            
            if (chartData.length > 0 && typeof Chart !== 'undefined') {
                const ctx = document.getElementById('myChart');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            data: chartData,
                            backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6'],
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20, font: { size: 11 } } } 
                        },
                        layout: { padding: 10 }
                    }
                });
            }

            const searchInput = document.getElementById('search-input');
            const items = document.querySelectorAll('.transacao-item');
            const noResults = document.getElementById('no-results');
            const buttons = document.querySelectorAll('.filter-btn');
            let currentType = 'all';

            function filterItems() {
                const term = searchInput.value.toLowerCase();
                let visibleCount = 0;
                items.forEach(item => {
                    const desc = item.getAttribute('data-desc') || '';
                    const cat = item.getAttribute('data-cat') || '';
                    const type = item.getAttribute('data-type');
                    const status = item.getAttribute('data-status');
                    const matchesText = desc.includes(term) || cat.includes(term);
                    let matchesType = true;
                    if (currentType === 'entrada') matchesType = type === 'entrada';
                    if (currentType === 'saida') matchesType = type === 'saida';
                    if (currentType === 'pendente') matchesType = status === 'pendente';
                    if (matchesText && matchesType) { item.classList.remove('hidden'); visibleCount++; } else { item.classList.add('hidden'); }
                });
                if (visibleCount === 0 && items.length > 0) noResults.classList.remove('hidden'); else noResults.classList.add('hidden');
            }

            if(searchInput) searchInput.addEventListener('input', filterItems);

            window.filterType = (type) => {
                currentType = type;
                buttons.forEach(btn => {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-white', 'dark:bg-slate-800', 'text-slate-600', 'dark:text-slate-300');
                });
                const activeBtn = document.getElementById('btn-' + type);
                if(activeBtn) {
                    activeBtn.classList.remove('bg-white', 'dark:bg-slate-800', 'text-slate-600', 'dark:text-slate-300');
                    activeBtn.classList.add('bg-blue-600', 'text-white');
                }
                filterItems();
            };
        });
    </script>
</Layout>