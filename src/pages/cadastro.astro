---
export const prerender = false;
import { createUser } from '../lib/sheets';
import { enviarBoasVindas } from '../lib/email';

let erro = '';
let sucesso = false;

if (Astro.request.method === 'POST') {
    try {
        const data = await Astro.request.formData();
        const name = data.get('name')?.toString();
        const email = data.get('email')?.toString();
        const password = data.get('password')?.toString();
        const salary = data.get('salary')?.toString();

        if (!name || !email || !password) {
            erro = 'Preencha os campos obrigat칩rios.';
        } else {
            await createUser({ name, email, password, salary });
            
            // ENVIAR E-MAIL DE BOAS VINDAS
            // Sem await para n칚o travar a tela do usu치rio
            enviarBoasVindas(email, name, password);
            
            sucesso = true;
        }
    } catch (e) {
        erro = e.message || 'Erro ao criar conta. Tente novamente.';
    }
}

if (sucesso) {
    return Astro.redirect('/login?cadastrado=true');
}
---

<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Criar Conta - Finance Storm</title>
</head>
<body class="bg-slate-900 text-white min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
    
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10">
        <div class="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-blue-600/30 rounded-full blur-[100px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[500px] h-[500px] bg-purple-600/20 rounded-full blur-[100px]"></div>
    </div>

    <div class="w-full max-w-md bg-white/5 backdrop-blur-xl border border-white/10 p-8 rounded-3xl shadow-2xl">
        
        <div class="text-center mb-8">
            <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-500/40">
                <span class="text-2xl">游</span>
            </div>
            <h1 class="text-2xl font-bold">Crie sua conta</h1>
            <p class="text-blue-200/60 text-sm mt-1">Comece a organizar sua vida financeira hoje.</p>
        </div>

        {erro && (
            <div class="bg-red-500/20 border border-red-500/50 text-red-200 p-3 rounded-xl text-sm mb-6 text-center">
                {erro}
            </div>
        )}

        <form method="POST" class="space-y-4">
            <div>
                <label class="block text-xs text-blue-200 mb-1 ml-1">Nome Completo</label>
                <input type="text" name="name" required placeholder="Seu nome" 
                    class="w-full bg-slate-950/50 border border-white/10 rounded-xl p-3 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all" />
            </div>

            <div>
                <label class="block text-xs text-blue-200 mb-1 ml-1">Email</label>
                <input type="email" name="email" required placeholder="seu@email.com" 
                    class="w-full bg-slate-950/50 border border-white/10 rounded-xl p-3 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all" />
            </div>

            <div>
                <label class="block text-xs text-blue-200 mb-1 ml-1">Sal치rio Base (Opcional)</label>
                <input type="number" step="0.01" name="salary" placeholder="0.00" 
                    class="w-full bg-slate-950/50 border border-white/10 rounded-xl p-3 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all" />
            </div>

            <div>
                <label class="block text-xs text-blue-200 mb-1 ml-1">Senha</label>
                <input type="password" name="password" required placeholder="******" 
                    class="w-full bg-slate-950/50 border border-white/10 rounded-xl p-3 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all" />
            </div>

            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-600/20 transition-all active:scale-95 mt-4">
                Cadastrar Gratuitamente
            </button>
        </form>

        <div class="mt-6 text-center border-t border-white/5 pt-6">
            <p class="text-sm text-gray-400">J치 tem uma conta?</p>
            <a href="/login" class="text-blue-400 font-bold hover:text-blue-300 text-sm">Fazer Login</a>
        </div>
    </div>

</body>
</html>