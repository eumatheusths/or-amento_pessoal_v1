---
export const prerender = false;
import Layout from '../layouts/Layout.astro';
import { getGoals, addGoal, updateGoalBalance, deleteGoal } from '../lib/db';

if (!Astro.cookies.has('user_session')) return Astro.redirect('/login');
const userId = Astro.cookies.get('user_session')?.value;

// PROCESSA FORMULÃRIOS
if (Astro.request.method === 'POST') {
    const data = await Astro.request.formData();
    const action = data.get('action');

    if (action === 'create') {
        await addGoal({
            user_id: userId,
            title: data.get('title'),
            target_amount: parseFloat(data.get('target_amount')),
            current_amount: parseFloat(data.get('initial_amount') || 0),
            icon: data.get('icon'),
            color: data.get('color')
        });
    } else if (action === 'deposit') {
        await updateGoalBalance(data.get('id'), data.get('amount'));
    } else if (action === 'delete') {
        await deleteGoal(data.get('id'));
    }
}

const metas = await getGoals(userId);
const money = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);
---

<Layout>
    <div class="p-6 flex items-center gap-4 bg-blue-900/20 border-b border-blue-800/30">
        <h1 class="text-xl font-bold text-blue-50 flex items-center gap-2">
            <span class="text-2xl">ğŸ†</span> Meus Objetivos
        </h1>
    </div>

    <main class="max-w-3xl mx-auto px-4 py-6 space-y-6">

        <div class="space-y-4">
            {metas.length === 0 && (
                <div class="text-center p-8 bg-blue-900/20 rounded-2xl border border-dashed border-blue-700">
                    <p class="text-blue-300">VocÃª ainda nÃ£o tem metas.</p>
                    <p class="text-sm text-blue-400">Crie uma abaixo para comeÃ§ar a poupar!</p>
                </div>
            )}

            {metas.map(meta => {
                const porcentagem = Math.min((meta.current_amount / meta.target_amount) * 100, 100);
                
                return (
                    <div class={`p-5 rounded-2xl border ${meta.color.replace('bg-', 'border-').replace('500', '500/30')} bg-blue-900/40 relative overflow-hidden group`}>
                        
                        <div class="flex justify-between items-start mb-4 relative z-10">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-blue-950/50 rounded-xl flex items-center justify-center text-2xl border border-white/5">
                                    {meta.icon}
                                </div>
                                <div>
                                    <h2 class="font-bold text-white">{meta.title}</h2>
                                    <p class="text-xs text-blue-200">Meta: {money(meta.target_amount)}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="text-lg font-bold text-white">{money(meta.current_amount)}</span>
                                <p class="text-xs text-blue-300">{porcentagem.toFixed(0)}%</p>
                            </div>
                        </div>

                        <div class="h-3 w-full bg-blue-950/50 rounded-full overflow-hidden relative z-10 border border-white/5 mb-4">
                            <div class={`h-full rounded-full transition-all duration-1000 ${meta.color}`} style={`width: ${porcentagem}%`}></div>
                        </div>

                        <div class="flex gap-2 relative z-10">
                            <form method="POST" class="flex-1 flex gap-2">
                                <input type="hidden" name="action" value="deposit" />
                                <input type="hidden" name="id" value={meta.id} />
                                <input type="number" name="amount" placeholder="R$ valor" required class="w-full bg-blue-950 border border-blue-800 rounded-lg px-3 py-2 text-sm text-white focus:border-green-500 outline-none" />
                                <button class="bg-green-600 text-white px-3 py-2 rounded-lg font-bold hover:bg-green-500 text-sm">+</button>
                            </form>
                            <form method="POST" onsubmit="return confirm('Apagar meta?')">
                                <input type="hidden" name="action" value="delete" />
                                <input type="hidden" name="id" value={meta.id} />
                                <button class="bg-red-500/20 text-red-400 px-3 py-2 rounded-lg hover:bg-red-500 hover:text-white transition-colors">ğŸ—‘ï¸</button>
                            </form>
                        </div>

                        <div class={`absolute -right-10 -bottom-10 w-32 h-32 rounded-full blur-3xl opacity-10 ${meta.color}`}></div>
                    </div>
                )
            })}
        </div>

        <div class="bg-blue-900/20 border border-blue-800/50 p-6 rounded-2xl mt-8">
            <h3 class="font-bold text-white mb-4 flex items-center gap-2">âœ¨ Criar Nova Meta</h3>
            <form method="POST" class="space-y-4">
                <input type="hidden" name="action" value="create" />
                
                <div>
                    <label class="text-xs text-blue-300">Nome da Meta</label>
                    <input type="text" name="title" required placeholder="Ex: Viagem, Carro..." class="w-full bg-blue-950 border border-blue-800 rounded-xl p-3 text-white focus:border-blue-500 outline-none" />
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-blue-300">Valor Alvo (R$)</label>
                        <input type="number" step="0.01" name="target_amount" required placeholder="10000" class="w-full bg-blue-950 border border-blue-800 rounded-xl p-3 text-white focus:border-blue-500 outline-none" />
                    </div>
                    <div>
                        <label class="text-xs text-blue-300">JÃ¡ tenho (R$)</label>
                        <input type="number" step="0.01" name="initial_amount" placeholder="0" class="w-full bg-blue-950 border border-blue-800 rounded-xl p-3 text-white focus:border-blue-500 outline-none" />
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-blue-300">Ãcone</label>
                        <select name="icon" class="w-full bg-blue-950 border border-blue-800 rounded-xl p-3 text-white outline-none">
                            <option value="ğŸ¯">ğŸ¯ Alvo</option>
                            <option value="âœˆï¸">âœˆï¸ Viagem</option>
                            <option value="ğŸš˜">ğŸš˜ Carro</option>
                            <option value="ğŸ ">ğŸ  Casa</option>
                            <option value="ğŸ›¡ï¸">ğŸ›¡ï¸ SeguranÃ§a</option>
                            <option value="ğŸ’">ğŸ’ Casamento</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-blue-300">Cor</label>
                        <select name="color" class="w-full bg-blue-950 border border-blue-800 rounded-xl p-3 text-white outline-none">
                            <option value="bg-blue-500">Azul</option>
                            <option value="bg-green-500">Verde</option>
                            <option value="bg-purple-500">Roxo</option>
                            <option value="bg-orange-500">Laranja</option>
                            <option value="bg-pink-500">Rosa</option>
                        </select>
                    </div>
                </div>

                <button class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg mt-2">
                    Criar Meta
                </button>
            </form>
        </div>

    </main>
</Layout>